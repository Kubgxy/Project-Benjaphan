pipeline {
  agent any

  parameters {
    booleanParam(
      name: 'USE_NO_CACHE',
      defaultValue: false,
      description: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ --no-cache ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà'
    )
  }

  environment {
    NODE_ENV = 'production'
  }

  stages {
    stage('üîÑ Clean Workspace') {
      steps {
        deleteDir()
      }
    }

    stage('üì• Checkout Source Code') {
      steps {
        checkout scm
      }
    }

    stage('üîê Load Secrets') {
      steps {
        withCredentials([
          string(credentialsId: 'MONGODB_URI', variable: 'MONGODB_URI'),
          string(credentialsId: 'PORT', variable: 'PORT'),
          string(credentialsId: 'JWT_SECRET', variable: 'JWT_SECRET'),
          string(credentialsId: 'GOOGLE_CLIENT_ID', variable: 'GOOGLE_CLIENT_ID'),
          string(credentialsId: 'GOOGLE_CLIENT_SECRET', variable: 'GOOGLE_CLIENT_SECRET'),
          string(credentialsId: 'FACEBOOK_CLIENT_ID', variable: 'FACEBOOK_CLIENT_ID'),
          string(credentialsId: 'FACEBOOK_CLIENT_SECRET', variable: 'FACEBOOK_CLIENT_SECRET')
        ]) {
          echo 'üîí Secrets loaded into environment'
        }
      }
    }

    stage('‚ôªÔ∏è Docker Down') {
      steps {
        sh 'docker-compose down --remove-orphans || true'
      }
    }

    stage('üê≥ Docker Build') {
      steps {
        script {
          if (params.USE_NO_CACHE) {
            sh 'docker-compose build --no-cache'
          } else {
            sh 'docker-compose build'
          }
        }
      }
    }

    stage('üöÄ Docker Up') {
      steps {
        sh 'docker-compose up -d'
      }
    }
  }

  post {
    success {
      echo '‚úÖ Deploy ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ'
    }
    failure {
      echo '‚ùå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö log ‡∏Ñ‡∏£‡∏±‡∏ö'
    }
  }
}
